name: Build, Test, Docs, Pages, Pre-Release & SLSA

on:
  push:
    branches: ["master"]
    paths:
      - 'src/**'
      - 'tsconfig.json'
      - 'typedoc.json'
      - 'package.json'
      - 'pnpm-lock.yaml'
  pull_request:
    branches: ["master"]
    paths:
      - 'src/**'
      - 'tsconfig.json'
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "ci-${{ github.ref }}"
  cancel-in-progress: false

# ============================================================
# BUILD / TEST / DOCS / PAGES
# ============================================================
jobs:
  build-and-deploy:
    if: github.event_name != 'release'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '25.x'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.x'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests (optional, soft-fail)
        run: pnpm test
        continue-on-error: true

      - name: Build project
        run: pnpm run build

      - name: Auto-commit dist (master only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          git config user.name "Auto-build Bot"
          git config user.email "action@github.com"
          git add dist/
          if git diff --staged --quiet; then
            echo "No dist changes"
          else
            git commit -m "ðŸš€ Auto-build dist [skip ci]"
          fi

      - name: Generate TypeDoc
        run: |
          mkdir -p docs
          if pnpm run | grep -q "docs"; then
            pnpm run docs --if-present
          else
            pnpm exec typedoc --options typedoc.json --out docs
          fi

      - name: Commit docs (master only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs
          if git diff --cached --quiet; then
            echo "No docs changes"
          else
            git commit -m "ðŸ“š Update docs [skip ci]"
          fi

      - name: Push changes
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          if git log origin/${{ github.ref_name }}..HEAD --oneline | grep -q .; then
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "Nothing to push"
          fi

      - name: Setup Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs

      - name: Deploy Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        id: deployment
        uses: actions/deploy-pages@v4

# ============================================================
# PRE-RELEASE
# ============================================================
  pre-release:
    needs: build-and-deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6

      - name: Generate tag
        id: tag
        run: |
          TAG="pre-$(date +'%Y.%m.%d-%H%M')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Zip dist
        run: zip -r dist.zip dist

      - name: Create Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Pre-release ${{ steps.tag.outputs.tag }}
          prerelease: true
          generate_release_notes: true
          files: dist.zip

# ============================================================
# SLSA v3 â€“ GENERIC GENERATOR
# ============================================================
  slsa-build:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    outputs:
      digests: ${{ steps.hash.outputs.digests }}

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 24

      - uses: pnpm/action-setup@v4
        with:
          version: '10.x'

      - run: pnpm install --frozen-lockfile
      - run: pnpm run build

      - name: Generate subject for provenance
        id: hash
        run: |
          set -euo pipefail
          files=$(git ls-files)
          echo "digests=$(sha256sum $files | base64 -w0)" >> "$GITHUB_OUTPUT"

  provenance:
    needs: slsa-build
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.slsa-build.outputs.digests }}"
      upload-assets: true
