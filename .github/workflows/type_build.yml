name: Build, Test, Docs, Pages, Pre-Release & SLSA

on:
  push:
    branches: ["master"]
    paths:
      - 'src/**'
      - 'tsconfig.json'
      - 'typedoc.json'
      - 'package.json'
      - 'pnpm-lock.yaml'
  pull_request:
    branches: ["master"]
    paths:
      - 'src/**'
      - 'tsconfig.json'
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "ci-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  # ============================================================
  # BUILD / TEST / DOCS / PAGES
  # ============================================================
  build-and-deploy:
    if: github.event_name != 'release'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node.js 25
        uses: actions/setup-node@v6
        with:
          node-version: '25.x'

      - name: Enable corepack and prepare pnpm 10
        run: |
          corepack enable
          corepack prepare pnpm@10.x --activate
          pnpm --version

      - name: Prepare pnpm lockfile if missing
        run: |
          if [ ! -f pnpm-lock.yaml ]; then
            echo "âš ï¸ pnpm-lock.yaml missing, generating..."
            pnpm install --shamefully-hoist
            git add pnpm-lock.yaml
            git commit -m "chore: generate pnpm-lock.yaml [skip ci]" || true
          else
            echo "pnpm-lock.yaml exists, using frozen lockfile"
          fi

      - name: Restore pnpm store cache
        uses: actions/cache@v5
        with:
          path: $(pnpm store path)
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: |
          if [ -f pnpm-lock.yaml ]; then
            pnpm install --frozen-lockfile
          else
            pnpm install --no-frozen-lockfile
          fi

      - name: Build project
        run: pnpm run build || pnpm exec tsdown src/index.ts --format esm,cjs --minify --clean

      - name: Run tests (optional, soft-fail)
        run: pnpm test
        continue-on-error: true

      - name: Auto-commit dist (master only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          git config user.name "Auto-build Bot"
          git config user.email "action@github.com"
          git add dist/ || true
          if git diff --staged --quiet; then
            echo "No dist changes"
          else
            git commit -m "ðŸš€ Auto-build dist [skip ci]" || true
          fi

      - name: Generate TypeDoc
        run: |
          mkdir -p docs
          pnpm exec typedoc --options typedoc.json --out docs
          touch docs/.nojekyll

      - name: Commit docs (master only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs || true
          if git diff --cached --quiet; then
            echo "No docs changes"
          else
            git commit -m "ðŸ“š Update docs [skip ci]" || true
          fi

      - name: Push changes
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          if git rev-parse --verify origin/${{ github.ref_name }} >/dev/null 2>&1; then
            if git log origin/${{ github.ref_name }}..HEAD --oneline | grep -q .; then
              git push origin HEAD:${{ github.ref_name }}
            else
              echo "Nothing to push"
            fi
          else
            git push origin HEAD:${{ github.ref_name }}
          fi

      - name: Setup Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs

      - name: Deploy Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        id: deployment
        uses: actions/deploy-pages@v4

  # ============================================================
  # PRE-RELEASE
  # ============================================================
  pre-release:
    needs: build-and-deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Generate tag
        id: tag
        run: |
          TAG="pre-$(date +'%Y.%m.%d-%H%M')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Zip dist if exists
        run: |
          if [ -d "dist" ]; then
            zip -r dist.zip dist
          else
            mkdir -p .release_placeholder
            zip -r dist.zip .release_placeholder
          fi

      - name: Create Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Pre-release ${{ steps.tag.outputs.tag }}
          prerelease: true
          generate_release_notes: true
          files: dist.zip

  # ============================================================
  # SLSA v3 â€“ GENERIC GENERATOR (on release created)
  # ============================================================
  slsa-build:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    outputs:
      digests: ${{ steps.hash.outputs.digests }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js 25 for SLSA
        uses: actions/setup-node@v6
        with:
          node-version: '25.x'

      - name: Enable corepack and prepare pnpm 10
        run: |
          corepack enable
          corepack prepare pnpm@10.x --activate
          pnpm --version

      - name: Cache pnpm store
        uses: actions/cache@v5
        with:
          path: $(pnpm store path)
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: |
          if [ -f pnpm-lock.yaml ]; then
            pnpm install --frozen-lockfile
          else
            pnpm install --no-frozen-lockfile
          fi

      - name: Build for provenance
        run: pnpm run build

      - name: Generate subject for provenance
        id: hash
        run: |
          set -euo pipefail
          files=$(git ls-files)
          sha256sum $files | awk '{print $1 "  " $2}' | sha256sum | awk '{print $1}' | xxd -r -p | base64 -w0 > /tmp/subject.b64 || true
          DIGEST=$(cat /tmp/subject.b64 || echo "")
          echo "digests=$DIGEST" >> "$GITHUB_OUTPUT"

  provenance:
    needs: slsa-build
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.slsa-build.outputs.digests }}"
      upload-assets: true
