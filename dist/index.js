Object.defineProperty(exports,`__esModule`,{value:!0});var e=Object.create,t=Object.defineProperty,n=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,i=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,o=(e,i,o,s)=>{if(i&&typeof i==`object`||typeof i==`function`)for(var c=r(i),l=0,u=c.length,d;l<u;l++)d=c[l],!a.call(e,d)&&d!==o&&t(e,d,{get:(e=>i[e]).bind(null,d),enumerable:!(s=n(i,d))||s.enumerable});return e},s=(n,r,a)=>(a=n==null?{}:e(i(n)),o(r||!n||!n.__esModule?t(a,`default`,{value:n,enumerable:!0}):a,n));let c=require(`soundcloud-key-fetch`);c=s(c);let l=require(`url`);l=s(l);let u=require(`m3u8stream`);u=s(u);let d=require(`axios`);d=s(d);let f=require(`path`);f=s(f);let p=require(`fs`);p=s(p);const ee=`https://api-v2.soundcloud.com/resolve`,m=e=>{if(!e.response?.status)return e;let t=e.message;switch(e.response.status){case 401:t=`Authentication failed. Is your Client ID correct?`;break;case 404:t=`Resource not found. It may be private or the URL is incorrect.`;break}return Error(t,{cause:e})},h=(e,...t)=>{let n=new l.URL(e);return t.forEach((e,r)=>{r%2==0&&n.searchParams.append(e,t[r+1])}),n.href},te=e=>{if(!e.includes(`https://soundcloud.com/discover/sets/personalized-tracks::`))return``;let t=e.split(`:`);return t.length<5?``:t[4]},g=(e,t)=>Error(`Expected resouce of kind: (${e}), received: (${t})`),ne=async(e,t,n,r,i)=>{let a=h(`https://api-v2.soundcloud.com/tracks`,`ids`,n.join(`,`),`client_id`,e);r&&i&&(a=h(a,`playlistId`,``+r,`playlistSecretToken`,i));try{let{data:e}=await t.get(a);return e}catch(e){throw m(e)}},_=async(e,t,n)=>{try{return(await n.get(h(`https://api-v2.soundcloud.com/resolve`,`url`,e,`client_id`,t),{withCredentials:!0})).data}catch(e){throw m(e)}},re=async(e,t,n)=>{let r=await _(e,t,n),i=[...r.tracks].map(e=>e.id),a=r.id,o=r.secret_token,s=r.tracks.filter(e=>!e.title);if(s.length===0)return r;let c=r.tracks.filter(e=>e.title),l=s.map(e=>e.id);if(l.length>50){let e=[];for(let t=0;t<=Math.floor(l.length/50);t++)e.push([]);for(let t=0;t<l.length;t++){let n=Math.floor(t/50);e[n].push(l[t])}let s=e.map(async e=>await b(t,n,e,a,o)),u=await Promise.all(s);return r.tracks=c.concat(...u),r.tracks=v(r.tracks,i),r}let u=await b(t,n,l,a,o);return r.tracks=c.concat(u),r.tracks=v(r.tracks,i),r},v=(e,t)=>{for(let n=0;n<t.length;n++)if(e[n].id!==t[n]){for(let r=0;r<e.length;r++)if(e[r].id===t[n]){let t=e[n];e[n]=e[r],e[r]=t}}return e},ie=async(e,t,n)=>{let r;if(e.includes(`https://soundcloud.com/discover/sets/personalized-tracks::`)){let i=te(e);if(!i)throw Error(`Could not parse track ID from given URL: `+e);let a;try{a=parseInt(i)}catch(t){throw Error(`Could not parse track ID from given URL: `+e)}if(r=(await b(t,n,[a]))[0],!r)throw Error(`Could not find track with ID: `+a)}else r=await _(e,t,n);if(!r.media)throw Error(`The given URL does not link to a Soundcloud track`);return r},y=async(e,t,n)=>{let r=await re(e,t,n);if(!r.tracks)throw Error(`The given URL does not link to a Soundcloud set`);return r},b=async(e,t,n,r,i)=>await ne(e,t,n,r,i);var x=ie;const ae=(e,t)=>e.filter(({format:e,snipped:n})=>{let r=!1;return t.protocol&&(r=e.protocol===t.protocol),t.format&&(r=e.mime_type===t.format),n&&(r=!1),r});var S=ae;const C=async(e,t,n)=>{let r=await n.get(h(e,`client_id`,t),{headers:{"User-Agent":`Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.7339.52 Safari/537.36`,Accept:`*/*`,"Accept-Encoding":`gzip, deflate, br`},withCredentials:!0});if(!r.data.url)throw Error(`Invalid response from Soundcloud. Check if the URL provided is correct: ${e}`);return r.data.url},w=async(e,t)=>(await t.get(e,{withCredentials:!0,responseType:`stream`})).data,T=e=>(0,u.default)(e),E=async(e,t,n,r,i,a)=>{try{let o=await n(e,t,a);return e.includes(`/progressive`)?await r(o,a):i(o)}catch(e){throw m(e)}},D=async(e,t,n)=>await E(e,t,C,w,T,n),O=async(e,t,n,r,i,a,o)=>{if(!j(e))throw Error(`Invalid media object provided`);return await a(e.url,t,o)},k=async(e,t,n)=>await O(e,t,C,w,T,D,n),oe=async(e,t,n)=>{let{data:{redirectUri:r}}=await n.get(h(`https://api-v2.soundcloud.com/tracks/${e}/download`,`client_id`,t)),{data:i}=await n.get(r,{responseType:`stream`});return i},A=async(e,t,n,r=!0)=>{let i=await x(e,t,n);if(i.downloadable&&r)try{return await oe(i.id,t,n)}catch(e){console.log(`Download link failed, trying transcoding...`)}let a=i.media.transcodings.filter(e=>j(e)&&e.url&&e.format&&(e.format.protocol===`hls`||e.format.protocol===`progressive`));if(a.length===0)throw Error(`No valid transcoding available for this track`);a.find(e=>e.format.protocol===`progressive`)||a[0];for(let e of a)try{return await k(e,t,n)}catch(t){if(console.log(`Transcoding failed: ${e.format.protocol}, trying next...`),e===a[a.length-1])throw t}},j=e=>!(!e||!e.url||!e.format||!e.format.protocol||![`hls`,`progressive`].includes(e.format.protocol)),M=/^https?:\/\/(m\.)?soundcloud\.com\/.+/,N=/^https?:\/\/(?:soundcloud\.app\.goo\.gl|on\.soundcloud\.com)\/.+/,se=/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,500}\.[a-zA-Z0-9()]{1,500}\b([-a-zA-Z0-9()@:%_+.~#?&/\\=;]*)/g,P=(e,t=!0,n)=>typeof e==`string`?M.test(e)||t&&N.test(e):!1,F=e=>{if(!P(e,!1)||!e.includes(`/sets/`))return!1;try{return new URL(e).pathname.includes(`/sets/`)}catch{return!1}},I=e=>P(e,!1)?e.startsWith(`https://soundcloud.com/discover/sets/personalized-tracks::`):!1,L=e=>{try{let t=new URL(e);return t.hostname===`m.soundcloud.com`?(t.hostname=`soundcloud.com`,t.toString()):e}catch{return e}},R=e=>N.test(e),z=async(e,t)=>{let n=new URL(e);n.searchParams.set(`d`,`1`);let{data:r}=await t.get(n.toString()),i=r.match(se);if(!i)throw Error(`Could not find any URL in the response from the Firebase URL: ${e}`);let a=i.find(e=>M.test(e));if(a)return a.replace(/\\u([\d\w]{4})/gi,(e,t)=>String.fromCharCode(parseInt(t,16)))};var B=P,V=function(e){return e.HLS=`hls`,e.PROGRESSIVE=`progressive`,e}(V||{});const H={HLS:V.HLS,PROGRESSIVE:V.PROGRESSIVE};let U=function(e){return e.MP3=`audio/mpeg`,e.OPUS=`audio/ogg; codecs="opus"`,e.AAC=`audio/aac`,e.AAC_LC=`audio/aac-lc`,e.FLAC=`audio/flac`,e.WAV=`audio/wav`,e.WEBM_OPUS=`audio/webm; codecs="opus"`,e.OGG_VORBIS=`audio/ogg; codecs="vorbis"`,e.ALAC=`audio/alac`,e.AIFF=`audio/aiff`,e.M4A=`audio/mp4; codecs="mp4a.40.2"`,e}({});const W={MP3:U.MP3,OPUS:U.OPUS,AAC:U.AAC,AAC_LC:U.AAC_LC,FLAC:U.FLAC,WAV:U.WAV,WEBM_OPUS:U.WEBM_OPUS,OGG_VORBIS:U.OGG_VORBIS,ALAC:U.ALAC,AIFF:U.AIFF,M4A:U.M4A},ce=`https://api-v2.soundcloud.com/search`,G=[`tracks`,`users`,`albums`,`playlists`,`all`],K=e=>e.toLowerCase().normalize(`NFD`).replace(/[\u0300-\u036f]/g,``).replace(/[^\w\s]/g,` `).replace(/\s+/g,` `).trim(),q=(e,t)=>{let n=K(e),r=K(t);if(n===r)return 1e3;if(r.includes(n))return 800;let i=n.split(` `).filter(e=>e.length>0),a=r.split(` `).filter(e=>e.length>0),o=0,s=0;i.forEach(e=>{a.some(t=>t===e)?(s++,o++):a.some(t=>t.includes(e)||e.includes(t))&&(o+=.5)});let c=Math.max(0,a.length-i.length)*10,l=s*100,u=o/i.length*500;return Math.max(0,u+l-c)},J=(e,t)=>{let n=K(e),r=[`remix`,`cover`,`live`,`acoustic`,`instrumental`,`karaoke`,`extended`,`radio edit`,`club mix`,`dub`,`version`,`edit`,`remaster`,`rework`,`bootleg`,`mashup`,`flip`],i=r.some(e=>n.includes(e)),a=r.some(e=>K(t).includes(e));return!i||a},le=async(e,t,n)=>{let r=``;if(e.limit||(e.limit=20),e.offset||(e.offset=0),e.resourceType||(e.resourceType=`tracks`),e.nextHref)r=h(e.nextHref,`client_id`,n);else if(e.query){if(!G.includes(e.resourceType))throw Error(`${e.resourceType} is not one of ${G.map(e=>`'${e}'`).join(`, `)}`);r=h(`https://api-v2.soundcloud.com/search${e.resourceType===`all`?``:`/${e.resourceType}`}`,`client_id`,n,`q`,e.query,`limit`,``+e.limit,`offset`,``+e.offset)}else throw Error(`One of options.query or options.nextHref is required`);let{data:i}=await t.get(r);return e.resourceType===`tracks`&&Array.isArray(i.collection)&&(i.collection=i.collection.filter(e=>!(!e||typeof e!=`object`||!e.permalink_url||!e.title||typeof e.duration==`number`&&e.duration>=29500&&e.duration<=30500||`region_restricted`in e&&e.region_restricted===!0||e.streamable!==!0||e.state&&e.state!==`finished`||e.policy===`BLOCK`||e.policy===`SNIP`||!e.media||!e.media.transcodings||e.media.transcodings.length===0||!e.media.transcodings.some(e=>e&&e.url&&(e.format?.protocol===`hls`||e.format?.protocol===`progressive`))||e.sharing===`private`&&!e.streamable)),e.query&&i.collection.sort((t,n)=>{let r=q(e.query,t.title),i=q(e.query,n.title),a=J(t.title,e.query)?50:0,o=J(n.title,e.query)?50:0,s=(t.likes_count||0)/1e3,c=(n.likes_count||0)/1e3,l=r+a+s;return i+o+c-l}),i.collection=i.collection.slice(0,Math.min(e.limit,10))),i},ue=async(e,t=10,n=0,r,i)=>{let{data:a}=await r.get(h(`https://api-v2.soundcloud.com/tracks/${e}/related`,`client_id`,i,`offset`,``+n,`limit`,``+t));return Array.isArray(a.collection)&&(a.collection=a.collection.filter(e=>!(!e||typeof e!=`object`||!e.permalink_url||!e.title||typeof e.duration==`number`&&e.duration>=29500&&e.duration<=30500||typeof e.duration==`number`&&e.duration<1e4||e.streamable!==!0||e.state&&e.state!==`finished`||e.policy===`BLOCK`||e.policy===`SNIP`))),a},de=async(e,t,n)=>{let r=await y(e,t,n),i=[];return[await Promise.all(r.tracks.map(e=>{let r=A(e.permalink_url,t,n);return i.push(e.title),r})),i]},Y=async(e,t,n)=>{let r=``;e.nextHref?r=h(e.nextHref,`client_id`,t):(e.limit||(e.limit=-1),e.offset||(e.offset=0),r=h(`https://api-v2.soundcloud.com/users/${e.id}/likes`,`client_id`,t,`limit`,``+(e.limit===-1?200:e.limit),`offset`,``+e.offset));let i,a=`start`;for(;a&&(e.limit>0||e.limit===-1);){let{data:o}=await n.get(r),s=o;if(!s.collection)throw Error(`Invalid JSON response received`);if(s.collection.length===0)return o;if(s.collection[0].kind!==`like`)throw g(`like`,s.collection[0].kind);if(s.collection=s.collection.reduce((e,t)=>t.track?e.concat(t):e,[]),i?i.collection.push(...s.collection):i=s,e.limit!==-1&&(e.limit-=s.collection.length,e.limit<=0))break;if(a=s.next_href,a){if(e.limit!==-1){let t=new URL(a);t.searchParams.set(`limit`,``+e.limit),a=t.toString()}r=h(a,`client_id`,t)}}return i},X=async(e,t,n)=>{let r=h(`https://api-v2.soundcloud.com/resolve`,`url`,e,`client_id`,t),{data:i}=await n.get(r);if(!i.avatar_url)throw Error(`JSON response is not a user. Is profile URL correct? : `+e);return i},Z=async(e,t,n,r)=>{let i=await x(e,t,r),a=S(i.media.transcodings,{format:n});if(a.length===0)throw Error(`Could not find media with specified format: (${n})`);return await k(a[0],t,r)};var Q=class{STREAMING_PROTOCOLS;FORMATS;_clientID;_filePath;axios;saveClientID=process.env.SAVE_CLIENT_ID?process.env.SAVE_CLIENT_ID.toLowerCase()===`true`:!1;stripMobilePrefix;convertFirebaseLinks;constructor(e){e||(e={}),e.saveClientID?(this.saveClientID=e.saveClientID,e.filePath&&(this._filePath=e.filePath)):e.clientID&&(this._clientID=e.clientID),e.axiosInstance?this.setAxiosInstance(e.axiosInstance):this.setAxiosInstance(d.default),e.stripMobilePrefix||(e.stripMobilePrefix=!0),e.convertFirebaseLinks||(e.convertFirebaseLinks=!0),this.stripMobilePrefix=e.stripMobilePrefix,this.convertFirebaseLinks=e.convertFirebaseLinks}filterMedia(e,t){return S(e,t)}async download(e,t=!0){let n=await this.getInfo(e);if(typeof n.duration==`number`&&n.duration>=29500&&n.duration<=30500)throw Error(`Ten utwór to najprawdopodobniej 30-sekundowy sample/prewka SoundCloud!`);if(`region_restricted`in n&&n.region_restricted===!0)throw Error(`Ten utwór jest niedostępny w Twoim regionie!`);if(n.streamable!==!0)throw Error(`Nie można streamować tego utworu!`);return A(await this.prepareURL(e),await this.getClientID(),this.axios,t)}async downloadFormat(e,t){return Z(await this.prepareURL(e),await this.getClientID(),t,this.axios)}async getInfo(e){return x(await this.prepareURL(e),await this.getClientID(),this.axios)}async getTrackInfoByID(e,t,n){return b(await this.getClientID(),this.axios,e,t,n)}async getSetInfo(e){return y(await this.prepareURL(e),await this.getClientID(),this.axios)}async search(e){return le(e,this.axios,await this.getClientID())}async related(e,t,n=0){return ue(e,t,n,this.axios,await this.getClientID())}async downloadPlaylist(e){return de(await this.prepareURL(e),await this.getClientID(),this.axios)}async getLikes(e){let t,n=await this.getClientID();if(e.id)t=e.id;else if(e.profileUrl)t=(await X(await this.prepareURL(e.profileUrl),n,this.axios)).id;else if(e.nextHref)return await Y(e,n,this.axios);else throw Error(`options.id or options.profileURL must be provided.`);return e.id=t,Y(e,n,this.axios)}async getUser(e){return X(await this.prepareURL(e),await this.getClientID(),this.axios)}setAxiosInstance(e){this.axios=e}isValidUrl(e){return B(e,this.convertFirebaseLinks,this.stripMobilePrefix)}isPlaylistURL(e){return F(e)}isPersonalizedTrackURL(e){return I(e)}isFirebaseURL(e){return R(e)}async getClientID(){return this._clientID||await this.setClientID(),this._clientID}async setClientID(e){if(!e){if(!this._clientID)if(this.saveClientID){let e=f.resolve(__dirname,this._filePath?this._filePath:`../client_id.json`),t=await this._getClientIDFromFile(e);if(t)this._clientID=t;else{this._clientID=await c.default.fetchKey();let t={clientID:this._clientID,date:new Date().toISOString()};p.writeFile(e,JSON.stringify(t),{},e=>{e&&console.log(`Failed to save client_id to file: `+e)})}}else this._clientID=await c.default.fetchKey();return this._clientID}return this._clientID=e,e}async _getClientIDFromFile(e){return new Promise((t,n)=>{if(!p.existsSync(e))return t(``);p.readFile(e,`utf8`,(r,i)=>{if(r)return n(r);let a;try{a=JSON.parse(i)}catch(e){return n(e)}if(!a.date&&!a.clientID)return n(Error(`Property 'data' or 'clientID' missing from client_id.json`));if(typeof a.clientID!=`string`)return n(Error(`Property 'clientID' is not a string in client_id.json`));if(typeof a.date!=`string`)return n(Error(`Property 'date' is not a string in client_id.json`));let o=new Date(a.date);return Number.isNaN(o.getDay())?n(Error(`Invalid date object from 'date' in client_id.json`)):new Date().getTime()-o.getTime()>=3600*24*1e3?(p.unlink(e,e=>{e&&console.log(`Failed to delete client_id.json: `+e)}),t(``)):t(a.clientID)})})}async prepareURL(e){return this.stripMobilePrefix&&(e=L(e)),this.convertFirebaseLinks&&R(e)&&(e=await z(e,this.axios)),e}};const $=new Q,fe=e=>new Q(e);$.STREAMING_PROTOCOLS=H,$.FORMATS=W;var pe=$;exports.SCDL=Q,exports.create=fe,exports.default=pe;
//# sourceMappingURL=index.js.map