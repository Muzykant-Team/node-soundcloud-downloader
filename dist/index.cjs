Object.defineProperty(exports,`__esModule`,{value:!0});var e=Object.create,t=Object.defineProperty,n=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,i=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,o=(e,i,o,s)=>{if(i&&typeof i==`object`||typeof i==`function`)for(var c=r(i),l=0,u=c.length,d;l<u;l++)d=c[l],!a.call(e,d)&&d!==o&&t(e,d,{get:(e=>i[e]).bind(null,d),enumerable:!(s=n(i,d))||s.enumerable});return e},s=(n,r,a)=>(a=n==null?{}:e(i(n)),o(r||!n||!n.__esModule?t(a,`default`,{value:n,enumerable:!0}):a,n));let c=require(`soundcloud-key-fetch`);c=s(c);let l=require(`url`),u=require(`axios`);u=s(u);let d=require(`m3u8stream`);d=s(d);let f=require(`path`);f=s(f);let p=require(`fs`);p=s(p);const ee=`https://api-v2.soundcloud.com/resolve`,m=e=>{if(!(0,u.isAxiosError)(e))return e instanceof Error?e:Error(`Unknown error occurred`,{cause:e});let t=e;if(!t.response){let e=t.code,n=e===`ECONNABORTED`||e===`ETIMEDOUT`?`Request timeout. Please check your connection.`:e===`ERR_NETWORK`?`Network error. Please check your internet connection.`:e===`ERR_CANCELED`?`Request was canceled.`:`Request failed. Please try again.`;return Error(n,{cause:t})}let n=t.response.status,r;switch(n){case 400:r=`Bad request. Please check the parameters.`;break;case 401:r=`Authentication failed. Is your Client ID correct?`;break;case 403:r=`Access forbidden. You may not have permission to access this resource.`;break;case 404:r=`Resource not found. It may be private or the URL is incorrect.`;break;case 429:r=`Rate limit exceeded. Please wait before making more requests.`;break;case 500:case 502:case 503:case 504:r=`SoundCloud server error. Please try again later.`;break;default:r=`Request failed with status ${n}: ${t.message}`}return Error(r,{cause:t})},h=(e,...t)=>{try{let n=new l.URL(e);if(t.length%2!=0)throw Error(`Parameters must be provided in key-value pairs. Received ${t.length} parameters.`);for(let e=0;e<t.length;e+=2){let r=t[e],i=t[e+1];r&&i!=null&&n.searchParams.append(r,i)}return n.href}catch(t){throw t instanceof TypeError?Error(`Invalid URL: ${e}`,{cause:t}):t}},te=e=>{if(!e||typeof e!=`string`||!e.includes(`https://soundcloud.com/discover/sets/personalized-tracks::`))return``;let t=e.lastIndexOf(`:`);return t===-1?``:e.slice(t+1)},g=(e,t)=>Error(`Expected resource of kind: (${e}), received: (${t})`);var _=function(e){return e.HLS=`hls`,e.PROGRESSIVE=`progressive`,e}(_||{});const v={HLS:_.HLS,PROGRESSIVE:_.PROGRESSIVE};let y=function(e){return e.DSD_512=`audio/dsd`,e.DSD_256=`audio/dsd`,e.DSD_128=`audio/dsd`,e.DSD_64=`audio/dsd`,e.DSD=`audio/dsd`,e.MQA=`audio/mqa`,e.FLAC_32_384=`audio/flac`,e.FLAC_24_192=`audio/flac`,e.FLAC_24_96=`audio/flac`,e.FLAC_24_48=`audio/flac`,e.FLAC_24=`audio/flac`,e.FLAC_16=`audio/flac`,e.FLAC=`audio/flac`,e.WAV_32F=`audio/wav`,e.WAV_32=`audio/wav`,e.WAV_24=`audio/wav`,e.WAV_16=`audio/wav`,e.WAV=`audio/wav`,e.AIFF_24=`audio/aiff`,e.AIFF_16=`audio/aiff`,e.AIFF=`audio/aiff`,e.ALAC_24=`audio/alac`,e.ALAC_16=`audio/alac`,e.ALAC=`audio/alac`,e.WMA_LOSSLESS=`audio/x-ms-wma`,e.APE=`audio/ape`,e.TTA=`audio/tta`,e.WAVPACK=`audio/wavpack`,e.WAVPACK_HYBRID=`audio/wavpack`,e.MUSEPACK=`audio/musepack`,e.OPTIMFROG=`audio/ofr`,e.SHORTEN=`audio/shn`,e.TAK=`audio/tak`,e.LA=`audio/la`,e.ATRAC_AL=`audio/atrac-al`,e.MKA_FLAC=`audio/x-matroska`,e.HLS_ALAC=`application/vnd.apple.mpegurl`,e.HLS_FLAC=`application/vnd.apple.mpegurl`,e.HLS_PCM=`application/vnd.apple.mpegurl`,e.DASH_FLAC=`application/dash+xml`,e.DASH_ALAC=`application/dash+xml`,e.AAC_320=`audio/mp4; codecs="mp4a.40.2"`,e.AAC_256=`audio/mp4; codecs="mp4a.40.2"`,e.MP3_320=`audio/mpeg`,e.MP3_256=`audio/mpeg`,e.OGG_VORBIS_500=`audio/ogg; codecs="vorbis"`,e.OGG_VORBIS_320=`audio/ogg; codecs="vorbis"`,e.OPUS_256=`audio/ogg; codecs="opus"`,e.HLS_AAC_320=`application/vnd.apple.mpegurl`,e.HLS_AAC_256=`application/vnd.apple.mpegurl`,e.DASH_AAC_320=`application/dash+xml`,e.DASH_AAC_256=`application/dash+xml`,e.AAC_224=`audio/mp4; codecs="mp4a.40.2"`,e.AAC_192=`audio/mp4; codecs="mp4a.40.2"`,e.AAC_160=`audio/mp4; codecs="mp4a.40.2"`,e.MP3_224=`audio/mpeg`,e.MP3_192=`audio/mpeg`,e.MP3_160=`audio/mpeg`,e.OGG_VORBIS_192=`audio/ogg; codecs="vorbis"`,e.OGG_VORBIS_160=`audio/ogg; codecs="vorbis"`,e.OPUS_160=`audio/ogg; codecs="opus"`,e.HLS_AAC_192=`application/vnd.apple.mpegurl`,e.HLS_AAC_160=`application/vnd.apple.mpegurl`,e.DASH_AAC_192=`application/dash+xml`,e.DASH_AAC_160=`application/dash+xml`,e.AAC_128=`audio/mp4; codecs="mp4a.40.2"`,e.AAC_96=`audio/mp4; codecs="mp4a.40.5"`,e.MP3_128=`audio/mpeg`,e.MP3_112=`audio/mpeg`,e.MP3_96=`audio/mpeg`,e.OPUS_128=`audio/ogg; codecs="opus"`,e.OPUS_96=`audio/ogg; codecs="opus"`,e.OGG_VORBIS_128=`audio/ogg; codecs="vorbis"`,e.OGG_VORBIS_96=`audio/ogg; codecs="vorbis"`,e.HLS_AAC_128=`application/vnd.apple.mpegurl`,e.HLS_AAC_96=`application/vnd.apple.mpegurl`,e.DASH_AAC_128=`application/dash+xml`,e.DASH_AAC_96=`application/dash+xml`,e.AAC_64=`audio/mp4; codecs="mp4a.40.29"`,e.AAC_48=`audio/mp4; codecs="mp4a.40.29"`,e.AAC_32=`audio/mp4; codecs="mp4a.40.29"`,e.MP3_64=`audio/mpeg`,e.MP3_48=`audio/mpeg`,e.MP3_32=`audio/mpeg`,e.OPUS_64=`audio/ogg; codecs="opus"`,e.OPUS_48=`audio/ogg; codecs="opus"`,e.OPUS_32=`audio/ogg; codecs="opus"`,e.HLS_AAC_64=`application/vnd.apple.mpegurl`,e.HLS_AAC_48=`application/vnd.apple.mpegurl`,e.DASH_AAC_64=`application/dash+xml`,e.DASH_AAC_48=`application/dash+xml`,e.MP3_PREVIEW=`audio/mpeg`,e.AAC=`audio/mp4; codecs="mp4a.40.2"`,e.AAC_LC=`audio/aac`,e.AAC_HE=`audio/mp4; codecs="mp4a.40.5"`,e.AAC_HE_V2=`audio/mp4; codecs="mp4a.40.29"`,e.AAC_XHE=`audio/mp4; codecs="mp4a.40.42"`,e.MP3=`audio/mpeg`,e.MP2=`audio/mpeg`,e.MP1=`audio/mpeg`,e.OPUS=`audio/ogg; codecs="opus"`,e.WEBM_OPUS=`audio/webm; codecs="opus"`,e.OGG_VORBIS=`audio/ogg; codecs="vorbis"`,e.OGG=`audio/ogg`,e.M4A=`audio/mp4`,e.MP4_AUDIO=`audio/mp4`,e.AC3=`audio/ac3`,e.EAC3=`audio/eac3`,e.DOLBY_ATMOS=`audio/eac3-joc`,e.DTS=`audio/vnd.dts`,e.DTS_HD=`audio/vnd.dts.hd`,e.DTS_X=`audio/vnd.dts.uhd`,e.AMR_NB=`audio/amr`,e.AMR_WB=`audio/amr-wb`,e.AMR=`audio/amr`,e.THREE_GPP=`audio/3gpp`,e.THREE_GPP2=`audio/3gpp2`,e.GSM=`audio/gsm`,e.G711_ULAW=`audio/basic`,e.G711_ALAW=`audio/x-alaw-basic`,e.WMA=`audio/x-ms-wma`,e.WMA_PRO=`audio/x-ms-wma`,e.WMA_VOICE=`audio/x-ms-wma`,e.REAL_AUDIO=`audio/vnd.rn-realaudio`,e.CAF=`audio/x-caf`,e.AU=`audio/basic`,e.SND=`audio/basic`,e.PCM_RAW=`audio/L16`,e.PCM_S16LE=`audio/L16`,e.PCM_S24LE=`audio/L24`,e.PCM_F32LE=`audio/L32`,e.MIDI=`audio/midi`,e.MID=`audio/midi`,e.SPEEX=`audio/ogg; codecs="speex"`,e.AC4=`audio/ac4`,e.MPEGH=`audio/mhas`,e.ATRAC=`audio/atrac`,e.ATRAC3=`audio/atrac3`,e.ATRAC3_PLUS=`audio/atrac3plus`,e.ATRAC9=`audio/atrac9`,e.XMA=`audio/xma`,e.XMA2=`audio/xma2`,e.BINK=`audio/bink`,e.MKA_VORBIS=`audio/x-matroska`,e.MKA=`audio/x-matroska`,e.AV1_AUDIO=`audio/av1`,e.USAC=`audio/usac`,e.EVS=`audio/evs`,e.LC3=`audio/lc3`,e.LC3_PLUS=`audio/lc3plus`,e.LYRA=`audio/lyra`,e.SATIN=`audio/satin`,e.ENCODEC=`audio/encodec`,e.SOUNDSTREAM=`audio/soundstream`,e.HLS_AAC=`application/vnd.apple.mpegurl`,e.HLS_FMP4=`application/vnd.apple.mpegurl`,e.DASH=`application/dash+xml`,e.SMOOTH=`application/vnd.ms-sstr+xml`,e.HLS_ANY=`application/vnd.apple.mpegurl`,e.DASH_ANY=`application/dash+xml`,e.AUDIO_ANY=`audio/*`,e}({});const ne=[y.DSD_512,y.DSD_256,y.DSD_128,y.DSD_64,y.DSD,y.MQA,y.FLAC_32_384,y.FLAC_24_192,y.FLAC_24_96,y.FLAC_24_48,y.FLAC_24,y.FLAC_16,y.FLAC,y.WAV_32F,y.WAV_32,y.WAV_24,y.WAV_16,y.WAV,y.AIFF_24,y.AIFF_16,y.AIFF,y.ALAC_24,y.ALAC_16,y.ALAC,y.WMA_LOSSLESS,y.APE,y.TTA,y.WAVPACK,y.WAVPACK_HYBRID,y.MUSEPACK,y.OPTIMFROG,y.SHORTEN,y.TAK,y.LA,y.ATRAC_AL,y.MKA_FLAC,y.HLS_ALAC,y.HLS_FLAC,y.HLS_PCM,y.DASH_FLAC,y.DASH_ALAC,y.AAC_320,y.AAC_256,y.MP3_320,y.MP3_256,y.OGG_VORBIS_500,y.OGG_VORBIS_320,y.OPUS_256,y.HLS_AAC_320,y.HLS_AAC_256,y.DASH_AAC_320,y.DASH_AAC_256,y.AAC_224,y.AAC_192,y.AAC_160,y.MP3_224,y.MP3_192,y.MP3_160,y.OGG_VORBIS_192,y.OGG_VORBIS_160,y.OPUS_160,y.HLS_AAC_192,y.HLS_AAC_160,y.DASH_AAC_192,y.DASH_AAC_160,y.AAC_128,y.AAC_96,y.MP3_128,y.MP3_112,y.MP3_96,y.OPUS_128,y.OPUS_96,y.OGG_VORBIS_128,y.OGG_VORBIS_96,y.HLS_AAC_128,y.HLS_AAC_96,y.DASH_AAC_128,y.DASH_AAC_96,y.AAC_64,y.AAC_48,y.AAC_32,y.MP3_64,y.MP3_48,y.MP3_32,y.OPUS_64,y.OPUS_48,y.OPUS_32,y.MP3_PREVIEW,y.HLS_AAC_64,y.HLS_AAC_48,y.DASH_AAC_64,y.DASH_AAC_48,y.AAC,y.AAC_LC,y.AAC_HE,y.AAC_HE_V2,y.AAC_XHE,y.MP3,y.OPUS,y.WEBM_OPUS,y.OGG_VORBIS,y.OGG,y.M4A,y.MP4_AUDIO,y.DOLBY_ATMOS,y.EAC3,y.AC3,y.DTS_X,y.DTS_HD,y.DTS,y.ATRAC9,y.ATRAC3_PLUS,y.ATRAC3,y.ATRAC,y.XMA2,y.XMA,y.BINK,y.MPEGH,y.USAC,y.AC4,y.LC3_PLUS,y.LC3,y.EVS,y.LYRA,y.SATIN,y.ENCODEC,y.SOUNDSTREAM,y.AV1_AUDIO,y.HLS_AAC,y.HLS_FMP4,y.DASH,y.SMOOTH,y.AMR_WB,y.AMR_NB,y.AMR,y.EVS,y.GSM,y.G711_ULAW,y.G711_ALAW,y.THREE_GPP,y.THREE_GPP2,y.MP2,y.MP1,y.WMA_PRO,y.WMA_VOICE,y.WMA,y.REAL_AUDIO,y.SPEEX,y.CAF,y.MKA,y.MKA_VORBIS,y.AU,y.SND,y.PCM_F32LE,y.PCM_S24LE,y.PCM_S16LE,y.PCM_RAW,y.MIDI,y.MID,y.HLS_ANY,y.DASH_ANY,y.AUDIO_ANY],b=Object.fromEntries(Object.entries(y).map(([e,t])=>[e,t])),re=new Set([y.DSD_512,y.DSD_256,y.DSD_128,y.DSD_64,y.DSD,y.MQA,y.FLAC_32_384,y.FLAC_24_192,y.FLAC_24_96,y.FLAC_24_48,y.FLAC_24,y.FLAC_16,y.FLAC,y.WAV_32F,y.WAV_32,y.WAV_24,y.WAV_16,y.WAV,y.AIFF_24,y.AIFF_16,y.AIFF,y.ALAC_24,y.ALAC_16,y.ALAC,y.WMA_LOSSLESS]),ie=new Set([y.AAC_320,y.AAC_256,y.AAC_224,y.AAC_192,y.AAC_160,y.AAC_128,y.AAC_96,y.AAC_64,y.AAC_48,y.AAC_32,y.AAC,y.AAC_LC,y.AAC_HE,y.AAC_HE_V2,y.AAC_XHE,y.M4A]),ae=new Set([...re,y.AAC_320,y.AAC_256,y.MP3_320,y.MP3_256]),oe=new Set([y.OPUS,y.OPUS_256,y.OPUS_160,y.OPUS_128,y.OPUS_96,y.OPUS_64,y.OPUS_48,y.OPUS_32,y.WEBM_OPUS,y.OGG_VORBIS,y.OGG_VORBIS_500,y.OGG_VORBIS_320,y.OGG_VORBIS_192,y.OGG_VORBIS_160,y.OGG_VORBIS_128,y.OGG_VORBIS_96]),se=async(e,t,n,r,i)=>{let a=h(`https://api-v2.soundcloud.com/tracks`,`ids`,n.join(`,`),`client_id`,e);r&&i&&(a=h(a,`playlistId`,String(r),`playlistSecretToken`,i));try{let{data:e}=await t.get(a);return e}catch(e){throw m(e)}},x=async(e,t,n)=>{try{return(await n.get(h(`https://api-v2.soundcloud.com/resolve`,`url`,e,`client_id`,t),{withCredentials:!0})).data}catch(e){throw m(e)}},ce=async(e,t,n)=>{let r=await x(e,t,n),i=r.tracks.map(e=>e.id),a=r.id,o=r.secret_token,s=r.tracks.filter(e=>!e.title);if(s.length===0)return r;let c=r.tracks.filter(e=>e.title),l=s.map(e=>e.id);if(l.length>50){let e=[];for(let t=0;t<l.length;t+=50)e.push(l.slice(t,t+50));let i=e.map(e=>T(t,n,e,a,o)),s=await Promise.all(i);r.tracks=c.concat(...s)}else{let e=await T(t,n,l,a,o);r.tracks=c.concat(e)}return r.tracks=S(r.tracks,i),r},S=(e,t)=>{let n=new Map;for(let t of e)n.set(t.id,t);let r=[];for(let e of t){let t=n.get(e);t&&r.push(t)}return r},C=async(e,t,n)=>{let r;if(e.includes(`https://soundcloud.com/discover/sets/personalized-tracks::`)){let i=te(e);if(!i)throw Error(`Could not parse track ID from given URL: `+e);let a=parseInt(i,10);if(isNaN(a))throw Error(`Could not parse track ID from given URL: `+e);let o=(await T(t,n,[a]))[0];if(!o)throw Error(`Could not find track with ID: `+a);r=o}else r=await x(e,t,n);if(!r.media)throw Error(`The given URL does not link to a Soundcloud track`);return r},w=async(e,t,n)=>{let r=await ce(e,t,n);if(!r.tracks)throw Error(`The given URL does not link to a Soundcloud set`);return r},T=async(e,t,n,r,i)=>await se(e,t,n,r,i);var E=C;const le=(e,t)=>e.filter(({format:e,snipped:n})=>!(n||t.protocol!==void 0&&e.protocol!==t.protocol||t.format!==void 0&&e.mime_type!==t.format));var D=le;const O=async(e,t,n)=>{let r=await n.get(h(e,`client_id`,t),{headers:{"User-Agent":`Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.7339.52 Safari/537.36`,Accept:`*/*`,"Accept-Encoding":`gzip, deflate, br`},withCredentials:!0});if(!r.data.url)throw Error(`Invalid response from Soundcloud. Check if the URL provided is correct: ${e}`);return r.data.url},k=async(e,t)=>(await t.get(e,{withCredentials:!0,responseType:`stream`})).data,A=e=>(0,d.default)(e),ue=async(e,t,n,r,i,a)=>{try{let o=await n(e,t,a);return e.includes(`/progressive`)?await r(o,a):i(o)}catch(e){throw m(e)}},de=async(e,t,n)=>await ue(e,t,O,k,A,n),fe=async(e,t,n,r,i,a,o)=>{if(!M(e))throw Error(`Invalid media object provided`);return await a(e.url,t,o)},j=async(e,t,n)=>await fe(e,t,O,k,A,de,n),pe=async(e,t,n)=>{let{data:{redirectUri:r}}=await n.get(h(`https://api-v2.soundcloud.com/tracks/${e}/download`,`client_id`,t)),{data:i}=await n.get(r,{responseType:`stream`});return i},M=e=>!(!e||!e.url||!e.format||!e.format.protocol||![`hls`,`progressive`].includes(e.format.protocol)),N=async(e,t,n,r=!0)=>{let i=await E(e,t,n);if(i.downloadable&&r)try{return await pe(i.id,t,n)}catch{console.log(`Download link failed, trying transcoding...`)}let a=i.media.transcodings.filter(e=>M(e)&&e.url&&e.format&&(e.format.protocol===`hls`||e.format.protocol===`progressive`));if(a.length===0)throw Error(`No valid transcoding available for this track`);a.find(e=>e.format.protocol===`progressive`)||a[0];for(let e=0;e<a.length;e++){let r=a[e];try{return await j(r,t,n)}catch(t){if(console.log(`Transcoding failed: ${r.format.protocol}, trying next...`),e===a.length-1)throw t}}},P=/^https?:\/\/(m\.)?soundcloud\.com\/.+/,F=/^https?:\/\/(?:soundcloud\.app\.goo\.gl|on\.soundcloud\.com)\/.+/,I=/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,500}\.[a-zA-Z0-9()]{1,500}\b([-a-zA-Z0-9()@:%_+.~#?&/\\=;]*)/g,me=`https://soundcloud.com/discover/sets/personalized-tracks::`,L=(e,t=!0,n)=>typeof e==`string`?P.test(e)||t&&F.test(e):!1,R=e=>{if(!L(e,!1)||!e.includes(`/sets/`))return!1;try{return new URL(e).pathname.includes(`/sets/`)}catch{return!1}},z=e=>typeof e==`string`?e.startsWith(`https://soundcloud.com/discover/sets/personalized-tracks::`):!1,B=e=>{try{let t=new URL(e);return t.hostname===`m.soundcloud.com`?(t.hostname=`soundcloud.com`,t.toString()):e}catch{return e}},V=e=>typeof e==`string`?F.test(e):!1,he=async(e,t)=>{let n=new URL(e);n.searchParams.set(`d`,`1`);let{data:r}=await t.get(n.toString());I.lastIndex=0;let i=r.match(I);if(!i||i.length===0)throw Error(`Could not find any URL in the response from the Firebase URL: ${e}`);let a=i.find(e=>P.test(e));if(a)return a.replace(/\\u([\d\w]{4})/gi,(e,t)=>String.fromCharCode(parseInt(t,16)))};var ge=L;const _e=`https://api-v2.soundcloud.com/search`,H=[`tracks`,`users`,`albums`,`playlists`,`all`],U=e=>e.toLowerCase().normalize(`NFD`).replace(/[\u0300-\u036f]/g,``).replace(/[^\w\s]/g,` `).replace(/\s+/g,` `).trim(),W=(e,t)=>{let n=U(e),r=U(t);if(n===r)return 1e3;if(r.includes(n))return 800;let i=n.split(` `).filter(e=>e.length>0),a=r.split(` `).filter(e=>e.length>0),o=0,s=0;i.forEach(e=>{a.some(t=>t===e)?(s++,o++):a.some(t=>t.includes(e)||e.includes(t))&&(o+=.5)});let c=Math.max(0,a.length-i.length)*10,l=s*100,u=o/i.length*500;return Math.max(0,u+l-c)},G=(e,t)=>{let n=U(e),r=[`remix`,`cover`,`live`,`acoustic`,`instrumental`,`karaoke`,`extended`,`radio edit`,`club mix`,`dub`,`version`,`edit`,`remaster`,`rework`,`bootleg`,`mashup`,`flip`],i=r.some(e=>n.includes(e)),a=r.some(e=>U(t).includes(e));return!i||a},ve=e=>!(!e||typeof e!=`object`||!e.permalink_url||!e.title||typeof e.duration==`number`&&e.duration>=29500&&e.duration<=30500||`region_restricted`in e&&e.region_restricted===!0||e.streamable!==!0||e.state&&e.state!==`finished`||e.policy===`BLOCK`||e.policy===`SNIP`||!e.media||!e.media.transcodings||e.media.transcodings.length===0||!e.media.transcodings.some(e=>e&&e.url&&(e.format?.protocol===`hls`||e.format?.protocol===`progressive`))||e.sharing===`private`&&!e.streamable),ye=async(e,t,n)=>{let r=``;e.limit||=20,e.offset||=0,e.resourceType||=`tracks`;let i=e.query||e.q;if(e.nextHref)r=h(e.nextHref,`client_id`,n);else if(i){if(!H.includes(e.resourceType))throw Error(`${e.resourceType} is not one of ${H.map(e=>`'${e}'`).join(`, `)}`);r=h(`https://api-v2.soundcloud.com/search${e.resourceType===`all`?``:`/${e.resourceType}`}`,`client_id`,n,`q`,i,`limit`,String(e.limit),`offset`,String(e.offset))}else throw Error(`One of options.query, options.q, or options.nextHref is required`);let{data:a}=await t.get(r);return e.resourceType===`tracks`&&Array.isArray(a.collection)&&(a.collection=a.collection.filter(ve),i&&a.collection.sort((e,t)=>{let n=W(i,e.title),r=W(i,t.title),a=G(e.title,i)?50:0,o=G(t.title,i)?50:0,s=(e.likes_count||0)/1e3,c=(t.likes_count||0)/1e3,l=n+a+s;return r+o+c-l}),a.collection=a.collection.slice(0,Math.min(e.limit,10))),a},be=async(e,t=10,n=0,r,i)=>{let{data:a}=await r.get(h(`https://api-v2.soundcloud.com/tracks/${e}/related`,`client_id`,i,`offset`,String(n),`limit`,String(t)));return Array.isArray(a.collection)&&(a.collection=a.collection.filter(e=>!(!e||typeof e!=`object`||!e.permalink_url||!e.title||typeof e.duration==`number`&&e.duration>=29500&&e.duration<=30500||typeof e.duration==`number`&&e.duration<1e4||e.streamable!==!0||e.state&&e.state!==`finished`||e.policy===`BLOCK`||e.policy===`SNIP`))),a},K=async(e,t,n)=>{let r=await w(e,t,n),i=[];return[await Promise.all(r.tracks.map(e=>{let r=N(e.permalink_url,t,n);return i.push(e.title),r})),i]},q=async(e,t,n)=>{let r=``;e.nextHref?r=h(e.nextHref,`client_id`,t):(e.limit===void 0&&(e.limit=-1),e.offset===void 0&&(e.offset=0),r=h(`https://api-v2.soundcloud.com/users/${e.id}/likes`,`client_id`,t,`limit`,String(e.limit===-1?200:e.limit),`offset`,String(e.offset)));let i,a=`start`;for(;a&&(e.limit>0||e.limit===-1);){let{data:o}=await n.get(r),s=o;if(!s.collection)throw Error(`Invalid JSON response received`);if(s.collection.length===0)return o;if(s.collection[0].kind!==`like`)throw g(`like`,s.collection[0].kind);if(s.collection=s.collection.reduce((e,t)=>t.track?e.concat(t):e,[]),i?i.collection.push(...s.collection):i=s,e.limit!==-1&&(e.limit-=s.collection.length,e.limit<=0))break;if(a=s.next_href,a){if(e.limit!==-1){let t=new URL(a);t.searchParams.set(`limit`,String(e.limit)),a=t.toString()}r=h(a,`client_id`,t)}}return i},J=async(e,t,n)=>{let r=h(`https://api-v2.soundcloud.com/resolve`,`url`,e,`client_id`,t),{data:i}=await n.get(r);if(!i.avatar_url)throw Error(`JSON response is not a user. Is profile URL correct? : `+e);return i},xe=1440*60*1e3;let Y=function(e){return e.NETWORK_ERROR=`NETWORK_ERROR`,e.INVALID_URL=`INVALID_URL`,e.CLIENT_ID_ERROR=`CLIENT_ID_ERROR`,e.TRACK_NOT_FOUND=`TRACK_NOT_FOUND`,e.REGION_RESTRICTED=`REGION_RESTRICTED`,e.NOT_STREAMABLE=`NOT_STREAMABLE`,e.SAMPLE_TRACK=`SAMPLE_TRACK`,e.FORMAT_NOT_FOUND=`FORMAT_NOT_FOUND`,e.FILE_SYSTEM_ERROR=`FILE_SYSTEM_ERROR`,e.PARSING_ERROR=`PARSING_ERROR`,e.RATE_LIMITED=`RATE_LIMITED`,e}({});const X=e=>e instanceof Error?e.message:typeof e==`string`?e:String(e);var Z=class e extends Error{type;originalError;url;retryAfter;constructor(t,n,r,i,a){super(t),this.name=`SCDLError`,this.type=n,this.originalError=r,this.url=i,this.retryAfter=a,typeof Error.captureStackTrace==`function`&&Error.captureStackTrace(this,e)}};const Se=async(e,t,n,r)=>{try{let i=D((await E(e,t,r)).media.transcodings,{format:n});if(i.length===0)throw new Z(`Nie można znaleźć mediów w określonym formacie: (${n})`,Y.FORMAT_NOT_FOUND,void 0,e);return await j(i[0],t,r)}catch(t){throw t instanceof Z?t:new Z(`Błąd podczas pobierania formatu: ${X(t)}`,Y.NETWORK_ERROR,t instanceof Error?t:void 0,e)}};var Q=class{STREAMING_PROTOCOLS;FORMATS;_clientID;_filePath;_maxRetries;_retryDelay;_timeout;_validateUrls;axios;saveClientID=process.env.SAVE_CLIENT_ID?process.env.SAVE_CLIENT_ID.toLowerCase()===`true`:!1;stripMobilePrefix;convertFirebaseLinks;constructor(e){e||={},e.saveClientID?(this.saveClientID=e.saveClientID,e.filePath&&(this._filePath=e.filePath)):e.clientID&&(this._clientID=e.clientID),this._maxRetries=e.maxRetries??3,this._retryDelay=e.retryDelay??1e3,this._timeout=e.timeout??3e4,this._validateUrls=e.validateUrls??!0,e.axiosInstance?this.setAxiosInstance(e.axiosInstance):this.setAxiosInstance(u.default),this._setupAxiosInterceptors(),e.stripMobilePrefix===void 0&&(e.stripMobilePrefix=!0),e.convertFirebaseLinks===void 0&&(e.convertFirebaseLinks=!0),this.stripMobilePrefix=e.stripMobilePrefix,this.convertFirebaseLinks=e.convertFirebaseLinks,this.STREAMING_PROTOCOLS=v,this.FORMATS=b}_parseRetryAfter(e){if(!e)return this._retryDelay;let t=String(e).trim();if(/^\d+$/.test(t)){let e=parseInt(t,10);return Math.max(e*1e3,this._retryDelay)}try{let e=new Date(t);if(isNaN(e.getTime()))return console.warn(`Nieprawidłowy format retry-after: ${t}`),this._retryDelay;let n=new Date,r=e.getTime()-n.getTime();if(r<=0)return console.warn(`Retry-after data w przeszłości: ${t}`),this._retryDelay;let i=3600*1e3;return r>i?(console.warn(`Retry-after data zbyt daleko w przyszłości: ${t}, używam 1 godziny`),i):r}catch(e){return console.warn(`Błąd parsowania retry-after jako data: ${t}`,e),this._retryDelay}}_setupAxiosInterceptors(){this.axios.defaults.timeout=this._timeout,this.axios.interceptors.response.use(e=>e,e=>{if(e.response){let t=e.response.status;if(t===429){let t=this._parseRetryAfter(e.response.headers[`retry-after`]);throw new Z(`Przekroczono limit zapytań. Spróbuj ponownie później.`,Y.RATE_LIMITED,e,e.config?.url,t)}else if(t===404)throw new Z(`Nie znaleziono zasobu.`,Y.TRACK_NOT_FOUND,e,e.config?.url);else if(t>=500&&t<600)throw new Z(`Błąd serwera (${t}): ${e.response.statusText}`,Y.NETWORK_ERROR,e,e.config?.url);else if(t===403)throw new Z(`Brak dostępu do zasobu. Możliwe że zasób jest prywatny lub Client ID jest nieprawidłowy.`,Y.CLIENT_ID_ERROR,e,e.config?.url);else if(t===401)throw new Z(`Nieautoryzowany dostęp. Client ID może być nieprawidłowy.`,Y.CLIENT_ID_ERROR,e,e.config?.url)}throw e.code===`ECONNABORTED`||e.code===`ETIMEDOUT`?new Z(`Przekroczono limit czasu żądania.`,Y.NETWORK_ERROR,e,e.config?.url):e.code===`ENOTFOUND`||e.code===`ECONNREFUSED`?new Z(`Nie można połączyć się z serwerem SoundCloud.`,Y.NETWORK_ERROR,e,e.config?.url):new Z(`Błąd sieci: ${X(e)}`,Y.NETWORK_ERROR,e,e.config?.url)})}async _withRetry(e,t={}){let n={maxRetries:this._maxRetries,retryDelay:this._retryDelay,currentAttempt:0,...t};for(;n.currentAttempt<=n.maxRetries;)try{return await e()}catch(e){if(n.currentAttempt++,e instanceof Z){if([Y.INVALID_URL,Y.REGION_RESTRICTED,Y.NOT_STREAMABLE,Y.SAMPLE_TRACK,Y.FORMAT_NOT_FOUND].includes(e.type))throw e;if(e.type===Y.RATE_LIMITED&&e.retryAfter&&n.currentAttempt<=n.maxRetries){await this._delay(e.retryAfter);continue}}if(n.currentAttempt>n.maxRetries)throw e;let t=n.retryDelay*2**(n.currentAttempt-1);await this._delay(t)}throw Error(`Nieoczekiwany błąd w logice retry`)}_delay(e){return new Promise(t=>setTimeout(t,e))}_validateUrl(e,t){if(this._validateUrls)try{if(!e||typeof e!=`string`)throw new Z(`URL musi być niepustym stringiem.`,Y.INVALID_URL,void 0,e);if(!this.isValidUrl(e))throw new Z(`Nieprawidłowy URL SoundCloud: ${e}`,Y.INVALID_URL,void 0,e)}catch(n){throw n instanceof Z?n:new Z(`Błąd podczas walidacji URL dla operacji ${t}: ${X(n)}`,Y.INVALID_URL,n,e)}}filterMedia(e,t){try{return D(e,t)}catch(e){throw new Z(`Błąd podczas filtrowania mediów: ${X(e)}`,Y.PARSING_ERROR,e)}}async download(e,t=!0){return this._withRetry(async()=>{this._validateUrl(e,`download`);try{let n=await this.getInfo(e);if(typeof n.duration==`number`&&n.duration>=29500&&n.duration<=30500)throw new Z(`Ten utwór to najprawdopodobniej 30-sekundowy sample/prewka SoundCloud!`,Y.SAMPLE_TRACK,void 0,e);if(`region_restricted`in n&&n.region_restricted===!0)throw new Z(`Ten utwór jest niedostępny w Twoim regionie!`,Y.REGION_RESTRICTED,void 0,e);if(n.streamable!==!0)throw new Z(`Nie można streamować tego utworu!`,Y.NOT_STREAMABLE,void 0,e);return N(await this.prepareURL(e),await this.getClientID(),this.axios,t)}catch(t){throw t instanceof Z?t:new Z(`Błąd podczas pobierania utworu: ${X(t)}`,Y.NETWORK_ERROR,t,e)}})}async downloadFormat(e,t){return this._withRetry(async()=>{this._validateUrl(e,`downloadFormat`);try{return Se(await this.prepareURL(e),await this.getClientID(),t,this.axios)}catch(n){throw n instanceof Z?n:new Z(`Błąd podczas pobierania formatu ${t}: ${X(n)}`,Y.NETWORK_ERROR,n,e)}})}async getInfo(e){return this._withRetry(async()=>{this._validateUrl(e,`getInfo`);try{return E(await this.prepareURL(e),await this.getClientID(),this.axios)}catch(t){throw t instanceof Z?t:new Z(`Błąd podczas pobierania informacji o utworze: ${X(t)}`,Y.NETWORK_ERROR,t,e)}})}async getTrackInfoByID(e,t,n){return this._withRetry(async()=>{try{if(!Array.isArray(e)||e.length===0)throw new Z(`IDs muszą być niepustą tablicą liczb.`,Y.INVALID_URL);return T(await this.getClientID(),this.axios,e,t,n)}catch(e){throw e instanceof Z?e:new Z(`Błąd podczas pobierania informacji o utworach po ID: ${X(e)}`,Y.NETWORK_ERROR,e)}})}async getSetInfo(e){return this._withRetry(async()=>{this._validateUrl(e,`getSetInfo`);try{return w(await this.prepareURL(e),await this.getClientID(),this.axios)}catch(t){throw t instanceof Z?t:new Z(`Błąd podczas pobierania informacji o secie: ${X(t)}`,Y.NETWORK_ERROR,t,e)}})}async search(e){return this._withRetry(async()=>{try{if(!e||!e.q&&!e.query)throw new Z(`Opcje wyszukiwania muszą zawierać query (q) lub query.`,Y.INVALID_URL);return ye(e,this.axios,await this.getClientID())}catch(e){throw e instanceof Z?e:new Z(`Błąd podczas wyszukiwania: ${X(e)}`,Y.NETWORK_ERROR,e)}})}async related(e,t,n=0){return this._withRetry(async()=>{try{if(!Number.isInteger(e)||e<=0)throw new Z(`ID musi być dodatnią liczbą całkowitą.`,Y.INVALID_URL);if(!Number.isInteger(t)||t<=0)throw new Z(`Limit musi być dodatnią liczbą całkowitą.`,Y.INVALID_URL);return be(e,t,n,this.axios,await this.getClientID())}catch(e){throw e instanceof Z?e:new Z(`Błąd podczas pobierania powiązanych utworów: ${X(e)}`,Y.NETWORK_ERROR,e)}})}async downloadPlaylist(e){return this._withRetry(async()=>{this._validateUrl(e,`downloadPlaylist`);try{if(!this.isPlaylistURL(e))throw new Z(`URL nie jest prawidłowym linkiem do playlisty SoundCloud.`,Y.INVALID_URL,void 0,e);return K(await this.prepareURL(e),await this.getClientID(),this.axios)}catch(t){throw t instanceof Z?t:new Z(`Błąd podczas pobierania playlisty: ${X(t)}`,Y.NETWORK_ERROR,t,e)}})}async getLikes(e){return this._withRetry(async()=>{try{let t,n=await this.getClientID();if(e.id)t=e.id;else if(e.profileUrl)this._validateUrl(e.profileUrl,`getLikes`),t=(await J(await this.prepareURL(e.profileUrl),n,this.axios)).id;else if(e.nextHref)return await q(e,n,this.axios);else throw new Z(`options.id lub options.profileURL musi być podane.`,Y.INVALID_URL);return e.id=t,q(e,n,this.axios)}catch(e){throw e instanceof Z?e:new Z(`Błąd podczas pobierania polubień: ${X(e)}`,Y.NETWORK_ERROR,e)}})}async getUser(e){return this._withRetry(async()=>{this._validateUrl(e,`getUser`);try{return J(await this.prepareURL(e),await this.getClientID(),this.axios)}catch(t){throw t instanceof Z?t:new Z(`Błąd podczas pobierania informacji o użytkowniku: ${X(t)}`,Y.NETWORK_ERROR,t,e)}})}setAxiosInstance(e){this.axios=e,this._setupAxiosInterceptors()}isValidUrl(e){try{return ge(e,this.convertFirebaseLinks,this.stripMobilePrefix)}catch{return!1}}isPlaylistURL(e){try{return R(e)}catch{return!1}}isPersonalizedTrackURL(e){try{return z(e)}catch{return!1}}isFirebaseURL(e){try{return V(e)}catch{return!1}}async getClientID(){try{if(this._clientID||await this.setClientID(),!this._clientID)throw new Z(`Nie można pobrać Client ID.`,Y.CLIENT_ID_ERROR);return this._clientID}catch(e){throw e instanceof Z?e:new Z(`Błąd podczas pobierania Client ID: ${X(e)}`,Y.CLIENT_ID_ERROR,e)}}async setClientID(e){try{if(!e){if(!this._clientID)if(this.saveClientID){let e=f.resolve(__dirname,this._filePath?this._filePath:`../client_id.json`),t=await this._getClientIDFromFile(e);if(t)this._clientID=t;else{this._clientID=await c.default.fetchKey();let t={clientID:this._clientID,date:new Date().toISOString()};try{await p.promises.writeFile(e,JSON.stringify(t))}catch(e){console.warn(`Nie można zapisać client_id do pliku: `+e)}}}else this._clientID=await c.default.fetchKey();if(!this._clientID)throw new Z(`Nie ma ustawionego Client ID.`,Y.CLIENT_ID_ERROR);return this._clientID}return this._clientID=e,e}catch(e){throw new Z(`Błąd podczas ustawiania Client ID: ${X(e)}`,Y.CLIENT_ID_ERROR,e)}}async _getClientIDFromFile(e){if(!p.existsSync(e))return``;try{let t=await p.promises.readFile(e,`utf8`),n;try{n=JSON.parse(t)}catch(e){throw new Z(`Błąd parsowania client_id.json`,Y.PARSING_ERROR,e instanceof Error?e:void 0)}if(!n.date||!n.clientID)throw new Z(`Brakuje właściwości 'date' lub 'clientID' w client_id.json`,Y.PARSING_ERROR);if(typeof n.clientID!=`string`)throw new Z(`Właściwość 'clientID' nie jest stringiem w client_id.json`,Y.PARSING_ERROR);if(typeof n.date!=`string`)throw new Z(`Właściwość 'date' nie jest stringiem w client_id.json`,Y.PARSING_ERROR);let r=new Date(n.date);if(Number.isNaN(r.getTime()))throw new Z(`Nieprawidłowy obiekt daty z 'date' w client_id.json`,Y.PARSING_ERROR);return Date.now()-r.getTime()>=864e5?(p.promises.unlink(e).catch(()=>{}),``):n.clientID}catch(e){throw e instanceof Z?e:new Z(`Błąd czytania pliku client_id.json: ${X(e)}`,Y.FILE_SYSTEM_ERROR,e instanceof Error?e:void 0)}}async prepareURL(e){try{let t=e;if(this.stripMobilePrefix&&(t=B(t)),this.convertFirebaseLinks&&V(t)){let e=await he(t,this.axios);if(!e)throw new Z(`Nie można przekonwertować Firebase URL na prawidłowy link SoundCloud.`,Y.INVALID_URL,void 0,t);t=e}return t}catch(t){throw t instanceof Z?t:new Z(`Błąd podczas przygotowywania URL: ${X(t)}`,Y.INVALID_URL,t,e)}}isRetryableError(e){return![Y.INVALID_URL,Y.REGION_RESTRICTED,Y.NOT_STREAMABLE,Y.SAMPLE_TRACK,Y.FORMAT_NOT_FOUND].includes(e.type)}clearClientID(){this._clientID=void 0}async healthCheck(){try{let e=await this.getClientID();return await this.getInfo(`https://soundcloud.com/mt-eden/still-alive`),{status:`ok`,clientID:e.substring(0,8)+`...`}}catch(e){return{status:`error`,error:(e instanceof Z,e.message)}}}setRetryOptions(e,t){if(!Number.isInteger(e)||e<0)throw new Z(`maxRetries musi być nieujemną liczbą całkowitą.`,Y.INVALID_URL);if(!Number.isInteger(t)||t<0)throw new Z(`retryDelay musi być nieujemną liczbą całkowitą.`,Y.INVALID_URL);this._maxRetries=e,this._retryDelay=t}getRetryOptions(){return{maxRetries:this._maxRetries,retryDelay:this._retryDelay}}setTimeout(e){if(!Number.isInteger(e)||e<=0)throw new Z(`Timeout musi być dodatnią liczbą całkowitą.`,Y.INVALID_URL);this._timeout=e,this.axios.defaults.timeout=e}getTimeout(){return this._timeout}setUrlValidation(e){this._validateUrls=e}isUrlValidationEnabled(){return this._validateUrls}};const $=new Q,Ce=e=>new Q(e);$.STREAMING_PROTOCOLS=v,$.FORMATS=b;var we=$;exports.SCDL=Q,exports.SCDLError=Z,exports.SCDLErrorType=Y,exports.create=Ce,exports.default=we;
//# sourceMappingURL=index.cjs.map